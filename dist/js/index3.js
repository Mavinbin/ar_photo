"use strict";!function(){var e={};e.global={timer1:null,oTraceWrap:document.getElementById("traceWrap"),oVideo:document.getElementById("video"),oTrace:document.getElementById("trace"),oDecorations:document.getElementById("decorations"),oGlass:document.getElementById("glass"),oShyLine:document.getElementById("shyLine"),oBeard:document.getElementById("beard"),traceCtx:document.getElementById("trace").getContext("2d"),traceStage:new createjs.Stage("trace"),canvasW:document.documentElement.clientWidth,canvasH:document.documentElement.clientHeight,ctracker:null,hatInitW:0,hatInitH:0,glassInitW:0,glassInitH:0,shyLineInitW:0,shyLineInitH:0},e.requestAnimationFrame=function(e,t){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(e){var t=(new Date).getTime(),a=Math.max(0,16-(t-lastTime)),i=window.setTimeout(function(){e(t+a)},a);return lastTime=t+a,i};return a.call(window,e,t)},e.domOperation=function(){var t=document.getElementById("btnShutter"),a=document.getElementById("btnRedo"),i=document.getElementById("traceBtns"),n=document.getElementById("resultBtns");t.addEventListener("click",function(){clearInterval(e.global.timer1),i.classList.remove("active"),n.classList.add("active"),e.global.oVideo.pause()}),a.addEventListener("click",function(){n.classList.remove("active"),i.classList.add("active"),e.global.oVideo.play(),e.requestAnimationFrame(e.track)})},e.log=function(e){var t=document.getElementById("log"),a=document.createElement("span"),i=document.createTextNode(e);a.appendChild(i),t.appendChild(a),console.log(e)},e.getSystem=function(){{var e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1;!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)}return t?"Android":"iOS"},e.enumerateDevices=function(){var t={audio:!1,video:{}},a=[];navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(i){i.forEach(function(e){"videoinput"===e.kind&&a.push(e.deviceId)}),t.video.deviceId="Android"===e.getSystem()?a[0]:a[a.length-1],e.getUserMedia(t)}).catch(function(e){alert(e)}):alert("您的设备不支持摄像头调用！")},e.getUserMedia=function(t){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(t).then(function(t){e.global.oVideo.srcObject=t,document.body.addEventListener("click",function(){e.global.oVideo.play()});var a=setInterval(function(){e.global.oVideo.videoWidth&&(e.initCanvas(e.global.oVideo.videoWidth,e.global.oVideo.videoHeight),clearInterval(a))},20)}).catch(function(e){console.log(e),"DevicesNotFoundError"===e.name||alert(e)}):alert("您的设备不支持摄像头调用！")},e.initCanvas=function(t,a){this.global.oVideo.setAttribute("width",t),this.global.oVideo.setAttribute("height",a),this.global.oTrace.setAttribute("width",t),this.global.oTrace.setAttribute("height",a),this.global.oDecorations.style.width=t+"px",this.global.oDecorations.style.height=a+"px",this.global.canvasW=t,this.global.canvasH=a,e.track()},e.track=function(){e.global.ctracker=new clm.tracker,e.global.ctracker.init(),e.global.ctracker.start(e.global.oVideo),e.drawLoop()},e.initDerections=function(t){var a=new Image;a.src="img/"+t+".png",a.onload=function(){var a=new createjs.Bitmap("img/"+t+".png"),i=a.getBounds(),n="img"+t[0].toUpperCase()+t.slice(1);e.global[n]=a,e.global[t+"InitW"]=i.width,e.global[t+"InitH"]=i.height,e.global.traceStage.addChild(e.global[n])}},e.drawLoop=function(){var t=e.global.ctracker.getCurrentPosition();if(requestAnimationFrame(e.drawLoop),t){var a=t[14][0]-t[0][0],i=180*Math.atan((t[62][0]-t[33][0])/(t[62][1]-t[33][1]))/Math.PI,n=a/400*e.global.hatInitW,o=a/400,l=e.global.hatInitH*o,c=t[41][0]-330/720*n-l*(t[62][0]-t[33][0])/(t[62][1]-t[33][1]),r=t[21][1]<=t[17][1]?t[21][1]-l:t[17][1]-l;e.global.imgHat.set({x:t[41][0]*o+c,y:t[41][1]*o+r,scaleX:o,scaleY:o,rotation:-i,regX:t[41][0],regY:t[41][1]}),e.global.traceStage.update(),e.global.traceStage.addChild(e.global.circle),e.global.circle.set({x:t[41][0],y:t[41][1]}),e.global.traceStage.update(),e.global.ctracker.draw(e.global.oTrace)}},e.init=function(){this.enumerateDevices(),e.initDerections("hat"),e.global.circle=new createjs.Shape,e.global.circle.graphics.beginFill("lightblue").drawCircle(0,0,4),this.global.glassInitW=e.global.oGlass.width,this.global.glassInitH=e.global.oGlass.height,this.global.shyLineInitW=e.global.oShyLine.width,this.global.shyLineInitH=e.global.oShyLine.height,e.domOperation()},window.onload=function(){e.init()}}();
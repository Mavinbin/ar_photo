"use strict";!function(){var e={};e.global={oTraceWrap:document.getElementById("traceWrap"),oVideo:document.getElementById("video"),oTrace:document.getElementById("trace"),oAssets:document.getElementById("assets"),traceCtx:document.getElementById("trace").getContext("2d"),traceStage:new createjs.Stage("trace"),canvasW:document.documentElement.clientWidth,canvasH:document.documentElement.clientHeight,requestAnimationFrameId:null,isPause:!1},e.roleInfo={},e.getUrlParam=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),i=window.location.search.substr(1).match(t);return null!==i?unescape(i[2]):""},e.domOperation=function(){var t=document.getElementById("btnShutter"),i=document.getElementById("btnRedo"),a=document.getElementById("traceBtns"),n=document.getElementById("resultBtns");t.addEventListener("click",function(){e.global.isPause=!0,e.global.oVideo.pause(),e.draw(),a.classList.remove("active"),n.classList.add("active")}),i.addEventListener("click",function(){e.global.isPause=!1,e.global.oVideo.play(),n.classList.remove("active"),a.classList.add("active")})},e.log=function(e){var t=document.getElementById("log"),i=document.createElement("span"),a=document.createTextNode(e);i.appendChild(a),t.appendChild(i),console.log(e)},e.getSystem=function(){{var e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1;!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)}return t?"Android":"iOS"},e.enumerateDevices=function(){var e=this,t={audio:!1,video:{}},i=[];navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(a){a.forEach(function(e){"videoinput"===e.kind&&i.push(e.deviceId)}),t.video.deviceId="Android"===e.getSystem()?i[0]:i[i.length-1],e.getUserMedia(t)}).catch(function(e){alert(e)}):alert("您的设备不支持摄像头调用！")},e.getUserMedia=function(e){var t=this;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(function(e){t.global.oVideo.srcObject=e,document.body.addEventListener("click",function(){t.global.oVideo.play()});var i=setInterval(function(){t.global.oVideo.videoWidth&&(t.initCanvas(t.global.oVideo.videoWidth,t.global.oVideo.videoHeight),t.initAssets(),clearInterval(i))},20)}).catch(function(e){console.log(e),"DevicesNotFoundError"===e.name||alert(e)}):alert("您的设备不支持摄像头调用！")},e.initCanvas=function(e,t){this.global.oVideo.setAttribute("width",e),this.global.oVideo.setAttribute("height",t),this.global.oTrace.setAttribute("width",e),this.global.oTrace.setAttribute("height",t)},e.initAssets=function(){var e=this,t=new Image;t.src="img/role_"+this.getUrlParam("id")+".png",t.onload=function(){var i=new createjs.Bitmap(t.src),a=i.getBounds();e.roleInfo.role=i,e.roleInfo.initW=a.width,e.roleInfo.initH=a.height,e.global.traceStage.addChild(i),e.global.traceStage.addChildAt(i,1),e.draw()}},e.draw=function(){var t=window.innerWidth/this.roleInfo.initW,i=(window.innerWidth,this.roleInfo.initH*t,(this.global.oVideo.videoWidth-window.innerWidth)/2),a=0;if(this.roleInfo.role.set({x:i,y:a,scaleX:t,scaleY:t}),this.global.isPause){var n=new createjs.Bitmap(e.global.oVideo);this.global.traceStage.addChild(n),this.global.traceStage.addChildAt(n,0)}this.global.traceStage.update()},e.init=function(){var t=this;t.enumerateDevices(),createjs.Ticker.addEventListener("tick",e.global.traceStage),t.domOperation()},window.onload=function(){e.init()}}();